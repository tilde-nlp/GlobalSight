# GBS-2384: separate tables for TU, TUV, leverage match.

ALTER TABLE company ADD COLUMN SEPARATE_LM_TU_TUV_TABLES SMALLINT(1) DEFAULT 0;
ALTER TABLE company ADD COLUMN MIGRATE_PROCESSING INT DEFAULT 0;


DROP TABLE IF EXISTS TRANSLATION_TU_TUV_INDEX CASCADE;
CREATE TABLE TRANSLATION_TU_TUV_INDEX
(
  COMPANY_ID INT(6) NOT NULL,
  TU_ID BIGINT(20) NOT NULL,
  TUV_ID BIGINT(20) NOT NULL,
  PRIMARY KEY (COMPANY_ID, TU_ID, TUV_ID)  
);

# Create tu-tuv index data
insert into translation_tu_tuv_index (company_id, tu_id, tuv_id)
select sp.company_id, tuv.tu_id, tuv.id
from translation_unit_variant tuv, translation_unit tu, source_page_leverage_group splg, source_page sp
where tuv.tu_id = tu.id
and tu.leverage_group_id = splg.lg_id
and splg.sp_id = sp.id;

# "LEVERAGE_MATCH" table :: COMPANY_ID
# ALTER TABLE LEVERAGE_MATCH ADD COLUMN COMPANY_ID INT(6) DEFAULT -1;

# Fill in the "company_id" column from source_page table.
# UPDATE LEVERAGE_MATCH AS lm, SOURCE_PAGE AS sp
# SET lm.COMPANY_ID = sp.COMPANY_ID
# WHERE lm.SOURCE_PAGE_ID = sp.ID;

ALTER TABLE TEMPLATE_PART MODIFY COLUMN TU_ID bigint(20) DEFAULT 0;
ALTER TABLE TEMPLATE_PART DROP FOREIGN KEY FK_TEMPLATE_PART_TU_ID;
UPDATE TEMPLATE_PART SET tu_id = 0 WHERE tu_id is null;

ALTER TABLE LEVERAGE_MATCH DROP FOREIGN KEY FK_LEVERAGE_MATCH_ORIGINAL_SOURCE_TUV_ID;
ALTER TABLE LEVERAGE_MATCH DROP FOREIGN KEY FK_LEVERAGE_MATCH_TARGET_LOCALE_ID;

ALTER TABLE TASK_TUV DROP FOREIGN KEY FK_TASK_TUV_CURRENT_TUV_ID;
ALTER TABLE TASK_TUV DROP FOREIGN KEY FK_TASK_TUV_PREVIOUS_TUV_ID;

ALTER TABLE IP_TM_TRG_T DROP FOREIGN KEY FK_IP_TM_TRG_T_TU_ID;

ALTER TABLE REMOVED_TAG DROP FOREIGN KEY FK_REMOVED_TAG_TU_ID;
ALTER TABLE REMOVED_PREFIX_TAG DROP FOREIGN KEY FK_REMOVED_PREFIX_TAG_TU_ID;
ALTER TABLE REMOVED_SUFFIX_TAG DROP FOREIGN KEY FK_REMOVED_SUFFIX_TAG_TU_ID;

ALTER TABLE IMAGE_REPLACE_FILE_MAP DROP FOREIGN KEY FK_IMAGE_REPLACE_FILE_MAP_TUV_ID;

ALTER TABLE TERM_LEVERAGE_MATCH DROP FOREIGN KEY FK_TERM_LEVERAGE_MATCH_SOURCE_TUV_ID;

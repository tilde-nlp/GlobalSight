# GBS-3474: big data operations
####################################################
ALTER TABLE company ADD COLUMN BIG_DATA_STORE_LEVEL SMALLINT(1) DEFAULT 1;

UPDATE company SET BIG_DATA_STORE_LEVEL = SEPARATE_LM_TU_TUV_TABLES;
####################################################
ALTER TABLE job 
ADD COLUMN TU_TABLE VARCHAR(128), 
ADD COLUMN TU_ARCHIVE_TABLE VARCHAR(128), 
ADD COLUMN TUV_TABLE VARCHAR(128), 
ADD COLUMN TUV_ARCHIVE_TABLE VARCHAR(128),
ADD COLUMN LM_TABLE VARCHAR(128), 
ADD COLUMN LM_ARCHIVE_TABLE VARCHAR(128);

UPDATE job, company
SET job.TU_TABLE = 'TRANSLATION_UNIT',
  job.TU_ARCHIVE_TABLE = 'TRANSLATION_UNIT_ARCHIVED',
  job.TUV_TABLE = 'TRANSLATION_UNIT_VARIANT',
  job.TUV_ARCHIVE_TABLE = 'TRANSLATION_UNIT_VARIANT_ARCHIVED',
  job.LM_TABLE = 'LEVERAGE_MATCH',
  job.LM_ARCHIVE_TABLE = 'LEVERAGE_MATCH_ARCHIVED'
WHERE job.COMPANY_ID = company.ID
AND company.SEPARATE_LM_TU_TUV_TABLES = 0;

UPDATE job, company
SET job.TU_TABLE = CONCAT('TRANSLATION_UNIT_', job.COMPANY_ID),
  job.TU_ARCHIVE_TABLE = CONCAT('TRANSLATION_UNIT_', job.COMPANY_ID, '_ARCHIVED'),
  job.TUV_TABLE = CONCAT('TRANSLATION_UNIT_VARIANT_', job.COMPANY_ID),
  job.TUV_ARCHIVE_TABLE = CONCAT('TRANSLATION_UNIT_VARIANT_', job.COMPANY_ID, '_ARCHIVED'),
  job.LM_TABLE = CONCAT('LEVERAGE_MATCH_', job.COMPANY_ID),
  job.LM_ARCHIVE_TABLE = CONCAT('LEVERAGE_MATCH_', job.COMPANY_ID, '_ARCHIVED')
WHERE job.COMPANY_ID = company.ID
AND company.SEPARATE_LM_TU_TUV_TABLES = 1;

## ALTER TABLE company DROP COLUMN SEPARATE_LM_TU_TUV_TABLES;

####################################################
ALTER TABLE source_page ADD COLUMN JOB_ID BIGINT(20);

UPDATE source_page, request
SET source_page.JOB_ID = request.JOB_ID
WHERE source_page.ID = request.PAGE_ID;

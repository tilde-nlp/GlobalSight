CREATE TABLE IF NOT EXISTS CVS_SERVER (
	ID BIGINT(20) NOT NULL AUTO_INCREMENT,
	NAME VARCHAR(200) NOT NULL,
	HOSTIP VARCHAR(20) NOT NULL,
	HOSTPORT INT DEFAULT 2401,
	PROTOCOL INT NOT NULL DEFAULT 0,
	SANDBOX VARCHAR(100) NOT NULL,
	COMPANYID BIGINT(20) NOT NULL,
	ISACTIVE CHAR(1) NOT NULL DEFAULT 'Y',
	PRIMARY KEY (ID),
	KEY FK_SERVER_COMPANY (COMPANYID),
	CONSTRAINT FK_SERVER_COMPANY FOREIGN KEY (COMPANYID) REFERENCES COMPANY (ID)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS CVS_SERVER_USER (
	ID BIGINT(20) NOT NULL AUTO_INCREMENT,
	SERVER BIGINT(20) NOT NULL,
	USERNAME VARCHAR(200) NOT NULL,
	LOGINNAME VARCHAR(200) NOT NULL,
	PASSWORD VARCHAR(32),
	PRIMARY KEY (ID),
	KEY FK_SERVER_USER (SERVER),
	CONSTRAINT FK_SERVER_USER FOREIGN KEY (SERVER) REFERENCES CVS_SERVER (ID)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS CVS_REPOSITORY (
	ID BIGINT(20) NOT NULL AUTO_INCREMENT,
	SERVER BIGINT(20) NOT NULL,
	NAME VARCHAR(100),
	REPOSITORY VARCHAR(100) NOT NULL,
	FOLDERNAME VARCHAR(100) NOT NULL,
	LOGINUSER VARCHAR(100) NOT NULL,
	LOGINPWD VARCHAR(32) NOT NULL,
	CVSROOTENV VARCHAR(1000) NOT NULL,
	ISACTIVE CHAR(1) NOT NULL DEFAULT 'Y',
	PRIMARY KEY (ID),
	KEY FK_REPOSITORY_SERVER (SERVER),
	CONSTRAINT FK_REPOSITORY_SERVER FOREIGN KEY (SERVER) REFERENCES CVS_SERVER (ID)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS CVS_MODULE (
	ID BIGINT(20) NOT NULL AUTO_INCREMENT,
	REPOSITORY BIGINT(20) NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	MODULENAME VARCHAR(100) NOT NULL,
	REALPATH VARCHAR(2000) NULL,
	ISACTIVE CHAR(1) NOT NULL DEFAULT 'Y',
	PRIMARY KEY (ID),
	KEY FK_MODULE_REPOSITORY (REPOSITORY),
	CONSTRAINT FK_MODULE_REPOSITORY FOREIGN KEY (REPOSITORY) REFERENCES CVS_REPOSITORY (ID)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS CVS_SOURCE_FILES (
	ID BIGINT(20) NOT NULL AUTO_INCREMENT,
	JOB_NAME VARCHAR(100) NOT NULL,
	FILENAME VARCHAR(2000) NOT NULL,
	STATUS INT NOT NULL DEFAULT 0,
	JOB_ID BIGINT(20) NULL,
	MODULE_ID BIGINT(20) NOT NULL,
	PRIMARY KEY (ID)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

ALTER TABLE MODULE_MAPPING ADD COLUMN COMPANY_ID BIGINT NOT NULL;
ALTER TABLE MODULE_MAPPING ADD COLUMN MODULE_ID BIGINT(20) NOT NULL;
ALTER TABLE MODULE_MAPPING DROP INDEX SOURCE_LOCALE;
ALTER TABLE MODULE_MAPPING DROP COLUMN USER_ID;
ALTER TABLE MODULE_MAPPING ADD UNIQUE INDEX MODULE_MAPPING_INDEX (COMPANY_ID, SOURCE_LOCALE, SOURCE_MODULE, TARGET_LOCALE, TARGET_MODULE);

ALTER TABLE CVS_MODULE ADD COLUMN LAST_CHECKOUT VARCHAR(50) NULL;
